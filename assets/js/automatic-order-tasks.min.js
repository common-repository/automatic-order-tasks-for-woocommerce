(()=>{"use strict";const e=(e=>{const{__:t}=wp.i18n;return{createBaseComponents:n=>{const a=e("#eam-order-options");a.children().remove();const s=n.find("option:selected"),i=s.text();a.append(function(e){return`<h2>${t("When an order reaches the status","aotfw-domain")}<div class="status-name">${e}</div></h2>`}(i));const o=s.val(),r=e(function(e){return`<div id="order-tasks-container" data-id="${e}">\n            <div class="loader"><div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>\n            <div class="notask-placeholder" style="display: none;">${t("No tasks are set for this order status.<br>Click the button below to add your first one!","aotfw-domain")}</div>\n            </div>`}(o));a.append(r);const l=e(`<button type="button" class="eam-button" id="new-task-btn"><i class="fa-solid fa-plus" style="margin-right: 5px; font-size: .84em"></i>${t("New Task","aotfw-domain")}</button>`);a.append(l);const d=e(`<button type="button" class="eam-button" id="save-changes-btn"><i class="fa-solid fa-floppy-disk" style="margin-right: 6px;"></i>${t("Save Changes","aotfw-domain")}</button>`);return a.append(d),{newTaskBtn:l,saveChangesBtn:d,orderTasksContainer:r,viewLogLink:e("#view-log-link")}},createNewTaskWindow:(t,n)=>{const a=e('<div class="backdrop-overlay"><div class="new-task-window"><div class="grid-container"></div><div class="close-btn"><i class="fa-solid fa-xmark"></i></div></div></div>');let s=[];for(const i of t){const t=i.getMeta(),o=e(`<div class="task-selector-unit" id="${t.id}" data-id="${t.id}">\n          <div class="task-icon"><i class="${t.icon}"></i></div>\n          <div class="task-text">${t.text}</div>\n        </div>`);o.on("click",(function(){a.remove(),n(i)})),s.push(o)}for(let t=0;t<2;t++){const t=e('<div class="task-selector-unit placeholder"></div>');s.push(t)}const i=a.find(".grid-container");s.forEach((e=>i.append(e))),a.find(".close-btn").on("click",(function(){a.remove()})),e("body").append(a)}}})(jQuery),t=e,n=(()=>{let e={};function t(t={},n="GET",a){return new Promise(((s,i)=>{a&&e[a]?s(e[a]):(t._ajax_nonce=eam_nonce,jQuery.ajax({url:ajaxurl,method:n,data:t,dataType:"json",success:function(t){a&&(e[a]=t),s(t)},error:function(e){i(e)}}))}))}return{getOrderManagementConfig:e=>t({action:"eam_get_order_tasks_config",id:e}),saveOrderStatusConfig:e=>t({action:"eam_post_order_tasks_config",data:e},"POST"),getPostCategories:()=>t({action:"eam_get_post_categories"},"GET","post_categories"),getUsers:()=>t({action:"eam_get_users"},"GET","users"),getShippingMethods:()=>t({action:"eam_get_shipping_methods"},"GET","shipping_methods")}})(),a=(e=>{let t=!1;return{load:()=>new Promise(((a,s)=>{const i=e("#order-tasks-container").data("id");n.getOrderManagementConfig(i).then((n=>{if(e(".loader").remove(),Array.isArray(n)&&n.length)for(const e of n)k.get(e.id).createFields(e);else e(".notask-placeholder").show();t=!1,a()})).catch((e=>{s(e)}))})),save:()=>new Promise(((a,s)=>{const i=e("#order-tasks-container"),o=i.find(".eam-task"),r=[];o.each((function(){const t=e(this),n=t.data("id"),a=t.find(".eam-task-meta-setting"),s={};a.each((function(){const t=e(this),n=t.data("id"),a=this.type;s[n]="checkbox"===a?t.prop("checked"):t.val()}));const i=t.find(".eam-field"),o={};i.each((function(){const t=e(this),n=t.data("id");o[n]=t.data("meta").getValue()})),r.push({id:n,fields:o,metaSettings:s})}));const l=JSON.stringify({orderStatus:i.data("id"),config:r});n.saveOrderStatusConfig(l).then((e=>{t=!1,a(e)})).catch((e=>{s(e)}))})),setDirty:()=>{t=!0},isDirty:()=>t}})(jQuery),s=a,i=function(e){const{__:t}=wp.i18n,n={PLAIN:1,EMAIL:2,HTML:3,SELECT:4,SELECT_MULTIPLE:5,TEXTAREA:6};function a(t){if(!t)return;const n=e('<div class="eam-params"></div>');if(t.length){const e=t.map((e=>`<span>${e}</span>`));n.append(e)}return n}return{FIELD_TYPE:(Object.freeze(n),n),getField:(i,o,r,l=null,d)=>{let c="";switch(r){case n.PLAIN:c=function(t,n,i){const o=e(`<div>\n        <label for="${t}">${n}</label>\n        <input type="text" name="${t}">\n        </input>\n    </div>`);if(i){const t=a(i);o.append(t),t.children().on("click",(function(){const t=o.find("input"),n=t.val().length?t.val().trimEnd()+" ":"";t.val(n+`{{${e(this).text()}}}`)}))}return{content:o,setup:()=>{o.find("input").on("change",(function(){s.setDirty()}))},getValue:()=>o.find("input").val(),setValue:e=>{o.find("input").val(e)}}}(i,o,l);break;case n.EMAIL:c=function(n,i,o){const r=e(`<div>\n        <label for="${n}">${i}</label>\n        <select name="${n}" multiple="multiple">\n        </select>\n      </div>`),l=a(o);r.append(l);const d={content:r,setup:()=>{const n=r.find("select");n.on("change",(function(){s.setDirty()})),n.select2({tags:!0,selectOnClose:!0,allowClear:!0,placeholder:t("Type email addresses here, or use a dynamic tag from below.","aotfw-domain"),tokenSeparators:[","," "],createTag:function(e){const t=e.term;return-1!==t.indexOf("@")||-1!==t.indexOf("{{")&&-1!==t.indexOf("}}")?{id:e.term,text:e.term.replace(/{{|}}/g,"")}:null}}).on("select2:open",(function(t){e(".select2-container--open .select2-dropdown--below").css("display","none")})),n.on("change",(function(e){n.trigger("select2:change",e)})),n.siblings(".select2").find("input").css("width","100%"),l.children().on("click",(function(){const t=r.find("select"),n=t.select2("data"),a=e(this).text();for(var s of n)if(s.text==a)return;const i=e.merge(n,[{id:`{{${e(this).text()}}}`,text:e(this).text()}]);t.select2("data",i);const o=(()=>{let e="";for(var t of i)e+=`<option value="${t.id}" data-select2-tag="true">${t.text}</option>`;return e})();t.html(o),t.val(i.map((e=>e.id))),t.trigger("change")}))},getValue:()=>r.find("select option").map((function(){return{label:e(this).text(),value:e(this).val()}})).get(),setValue:e=>{if(!e.length)return;const t=r.find("select");for(const n of e)t.append(`<option value="${n.value}" data-select2-tag="true">${n.label}</option>`);t.val(e.map((e=>e.value))),t.trigger("change")}};return d}(i,o,l);break;case n.HTML:c=function(t,n,s){const i=e(`<div class="editor-container" name="${t}"></div>`);return{content:i,setup:()=>{let o=Quill.import("blots/embed");Quill.register(class extends o{static tagName="br";static blotName="breaker"});const r=new Quill(i[0],{modules:{toolbar:[[{header:[1,2,3,!1]}],["bold","italic","underline"]],keyboard:{bindings:{linebreak:{key:13,shiftKey:!0,handler:function(e){return this.quill.insertEmbed(e.index,"breaker",!0,Quill.sources.USER),this.quill.setSelection(e.index+1,Quill.sources.SILENT),!1}}}}},theme:"snow"}),l=a(s);i.wrap("<div></div>"),i.parent().parent().prepend(`<label for="${t}">${n}</label>`),i.parent().append(l),l.children().on("click",(function(){const t=r.getSelection(!0);r.insertText(t.index,`{{${e(this).text()}}}`)})),i.data("quill",r)},getValue:()=>i.find(".ql-editor").html(),setValue:e=>{i.find(".ql-editor").html(e)}}}(i,o,l);break;case n.SELECT:c=function(t,n,a){const i=e(`<div>\n        <label for="${t}">${n}</label>\n        <select type="text" name="${t}">\n        </select>\n    </div>`);return a&&i.append(`<div class="info">${a}</div>`),{content:i,setup:()=>{const e=i.find("select");e.select2(),e.on("change",(function(t){e.trigger("select2:change",t),s.setDirty()}))},getValue:()=>i.find("select").val(),setValue:e=>{i.find("select").val(e)}}}(i,o,d);break;case n.SELECT_MULTIPLE:c=function(t,n,a){const i=e(`<div>\n        <label for="${t}">${n}</label>\n        <select type="text" multiple="multiple" name="${t}">\n        </select>\n    </div>`);return a&&i.append(`<div class="info">${a}</div>`),{content:i,setup:()=>{const e=i.find("select");e.select2(),e.on("change",(function(){s.setDirty()}))},getValue:()=>i.find("select").val(),setValue:e=>{i.find("select").val(e)}}}(i,o,d);break;case n.TEXTAREA:c=function(t,n,i){const o=e(`<div>\n        <label for="${t}">${n}</label>\n        <textarea name="${t}"></textarea>\n    </div>`),r=a(i);return o.append(r),{content:o,setup:()=>{const t=o.find("textarea");t.on("change",(function(){s.setDirty()})),r.children().on("click",(function(){const n=t,a=n.val().length?n.val().trimEnd()+" ":"";n.val(a+`{{${e(this).text()}}}`)}))},getValue:()=>o.find("textarea").val(),setValue:e=>{o.find("textarea").val(e)}}}(i,o,l);break;default:throw new Error("no such fieldtype")}const u=e(`<div class="eam-field" data-id="${i}"></div>`);return u.append(c.content),u.data("meta",c),{container:u,...c}}}}(jQuery),o=i,r=e=>{const{__:t}=wp.i18n,n=jQuery;function a(){return`<strong class="task-meta-settings-headline">${t("Task Settings","aotfw-domain")}</strong>`}return e||(e=[]),{getContent:()=>{const i=n('<div class="eam-task-meta-settings-container" style="display: none;"></div>');i.append(a);const o=n(`\n    <label><input type="checkbox" ${!0===e.runonce?"checked":""} class="eam-task-meta-setting" data-id="runonce" name="task-meta-runonce"></input> ${t("Only run once","aotfw-domain")}</label>\n    <span class="eam-tooltip">?<span class="tooltip-text">${t("Limits the task to only run the first time the order reaches the order status.","aotfw-domain")}</span></span>\n    `);o.on("change",(function(){s.setDirty()})),i.append(o);const r=n(`<button class="eam-button task-meta-settings-ok-btn">${t("OK","aotfw-domain")}</button>`);return r.on("click",(function(){n(this).parent().css("display","none")})),i.append(r),i}}},{__:l}=wp.i18n,d=jQuery;class c{_meta=null;constructor(e,t,n){this._meta={id:e,icon:t,text:n}}getMeta(){return this._meta}getTasksContainer(){return d("#order-tasks-container")}getDefaultTagsForTextarea(){return["order id","order details","billing email","billing name","billing phone","billing company","billing address","shipping name","shipping address","order note"]}getDefaultTagsForField(){return["order id","billing name","billing phone","billing company","shipping name"]}createFields(e=null){throw new Error("Method 'createFields()' must be implemented.")}_getFieldGroup(e=null){const t=d(`<div data-id="${this.getMeta().id}" class="accordion-panel eam-task"></div>`),n=r(e?e.metaSettings:null).getContent(),a=d('<div class="eam-task-options"></div>'),i=d(`<a href="#" class="eam-task-option eam-task-settings">${l("Settings","aotfw-domain")}</a>`);i.on("click",(function(){return d(this).parent().siblings(".eam-task-meta-settings-container").first().css("display",""),!1}));const o=d(`<a href="#" class="eam-task-option eam-remove-task">${l("Remove","aotfw-domain")}</a>`);return o.on("click",(function(){const e=d(this).parents(".eam-task").first(),t=e.prev();e.remove(),t.remove();const n=d("#order-tasks-container");return n.find(".eam-task").length||n.find(".notask-placeholder").show(),s.setDirty(),!1})),a.append(i),a.append(o),t.append(n),t.append(a),t}_createAccordion(e=null){e||(e=this._meta.text),d(".notask-placeholder").hide();const t=d(`<button class="accordion"><span>${e}</span></button>`),n=this.getTasksContainer();return n.find(".placeholder").hide(),n.append(t),t.on("click",(function(){const e=d(this);e.siblings(".active").click(),e.toggleClass("active");const t=e.next();"block"===t.css("display")?t.css("display","none"):t.css("display","block")})),t}}class u extends c{constructor(){super("sendmail","fa-solid fa-envelope",l("Send Email","aotfw-domain"))}createFields(e=null){const t=this._getFieldGroup(e),n=o.getField("recipients",l("Recipients","aotfw-domain"),o.FIELD_TYPE.EMAIL,["billing email","admin email"]),a=this.getDefaultTagsForField(),s=o.getField("subject",l("Subject","aotfw-domain"),o.FIELD_TYPE.PLAIN,a),i=this.getDefaultTagsForTextarea(),r=o.getField("message",l("Message","aotfw-domain"),o.FIELD_TYPE.HTML,i);t.append(n.container),t.append(s.container),t.append(r.container);const d=this._createAccordion();return this.getTasksContainer().append(t),n.setup(),s.setup(),r.setup(),e&&(n.setValue(e.fields.recipients),s.setValue(e.fields.subject),r.setValue(e.fields.message)),d}}class p extends c{constructor(){super("createpost","fa-solid fa-pen-to-square",l("Create Post","aotfw-domain"))}createFields(e=null){const t=this._getFieldGroup(e),a=this.getDefaultTagsForField(),s=o.getField("subject",l("Subject","aotfw-domain"),o.FIELD_TYPE.PLAIN,a),i=this.getDefaultTagsForTextarea(),r=o.getField("content",l("Content","aotfw-domain"),o.FIELD_TYPE.HTML,i),d=o.getField("categories",l("Categories","aotfw-domain"),o.FIELD_TYPE.SELECT_MULTIPLE),c=o.getField("author",l("Author","aotfw-domain"),o.FIELD_TYPE.SELECT,null,'* The "Customer of order" option only functions when the customer is not a guest.');t.append(s.container),t.append(r.container),t.append(d.container),t.append(c.container);const u=this._createAccordion();return this.getTasksContainer().append(t),s.setup(),r.setup(),d.setup(),c.setup(),e&&(s.setValue(e.fields.subject),r.setValue(e.fields.content)),n.getPostCategories().then((t=>{let n="";for(let e of t)n+=`<option value="${e.cat_ID}">${e.cat_name}</option>`;d.container.find("select").append(n),e&&d.setValue(e.fields.categories)})),n.getUsers().then((t=>{let n=`<option value="{{customer}}">${l("{{ Customer of order }} *")}</option>`;for(let e of t)n+=`<option value="${e.ID}">${e.display_name}</option>`;c.container.find("select").append(n),e&&c.setValue(e.fields.author)})),u}}class f extends c{constructor(){super("logtofile","fa-solid fa-file-lines",l("Log To File","aotfw-domain"))}createFields(e=null){const t=this._getFieldGroup(e),n=this.getDefaultTagsForTextarea().filter((e=>"order details"!==e)),a=o.getField("content",l("Content","aotfw-domain"),o.FIELD_TYPE.TEXTAREA,n);t.append(a.container);const s=this._createAccordion();return this.getTasksContainer().append(t),a.setup(),e&&a.setValue(e.fields.content),s}}class g extends c{constructor(){super("customorderfield","fa-solid fa-dice-d6",l("Custom Order Field","aotfw-domain"))}createFields(e=null){const t=this._getFieldGroup(e),n=this.getDefaultTagsForField().filter((e=>"order details"!==e)),a=o.getField("name",l("Name","aotfw-domain"),o.FIELD_TYPE.PLAIN,n),s=this.getDefaultTagsForTextarea(),i=o.getField("value",l("Value","aotfw-domain"),o.FIELD_TYPE.TEXTAREA,s);t.append(a.container),t.append(i.container);const r=this._createAccordion();return this.getTasksContainer().append(t),a.setup(),i.setup(),e&&(a.setValue(e.fields.name),i.setValue(e.fields.value)),r}}class h extends c{constructor(){super("changeshipping","fa-solid fa-truck-fast",l("Change Ship. Method","aotfw-domain"))}createFields(e=null){const t=this._getFieldGroup(e),a=this.getDefaultTagsForField(),s=o.getField("new_shipping_name",l("New Shipping Title (optional)","aotfw-domain"),o.FIELD_TYPE.PLAIN,a),i=o.getField("new_shipping_method",l("New Shipping Method","aotfw-domain"),o.FIELD_TYPE.SELECT);t.append(s.container),t.append(i.container);const r=this._createAccordion();return this.getTasksContainer().append(t),s.setup(),i.setup(),e&&s.setValue(e.fields.new_shipping_name),n.getShippingMethods().then((t=>{let n="";for(let e of t)n+=`<option value="${e.id}">${e.method_title}</option>`;i.container.find("select").append(n),e&&i.setValue(e.fields.new_shipping_method)})),r}}class m extends c{constructor(){super("sendwebhook","fa-solid fa-satellite-dish",l("Send Webhook","aotfw-domain"))}createFields(e=null){const t=this._getFieldGroup(e),n=o.getField("delivery_url",l("Delivery URL","aotfw-domain"),o.FIELD_TYPE.PLAIN),a=o.getField("secret",l("Secret Key","aotfw-domain"),o.FIELD_TYPE.PLAIN);t.append(n.container),t.append(a.container);const s=this._createAccordion();return this.getTasksContainer().append(t),n.setup(),a.setup(),e&&(n.setValue(e.fields.delivery_url),a.setValue(e.fields.secret)),s}}class v extends c{constructor(){super("trashorder","fa-solid fa-trash",l("Trash Order","aotfw-domain"))}createFields(e=null){const t=this._getFieldGroup(e),n=o.getField("reason",l("Reason (optional)","aotfw-domain"),o.FIELD_TYPE.PLAIN);t.append(n.container);const a=this._createAccordion();return this.getTasksContainer().append(t),n.setup(),e&&n.setValue(e.fields.reason),a}}const k=(()=>{const e={sendmail:u,createpost:p,logtofile:f,customorderfield:g,changeshipping:h,sendwebhook:m,trashorder:v};return{get:t=>{const n=e[t];if(!n)throw new Error(`Task with ID: ${t} not found in orderTaskFactory`);return new n}}})(),w=(e=>{let t;return{displayMessage:(n,a=!0)=>{const s=e("#aotfw-msg-box");s.text(n),s.css("background-color",a?"#57ab57":"#e75d5d"),s.css("opacity",1),clearTimeout(t),t=setTimeout((()=>{s.css("opacity",0)}),5e3)}}})(jQuery),b=w;jQuery((e=>{const{__:n}=wp.i18n,a=[new u,new p,new h,new f,new g,new m,new v],i=e("#eam-order-stage"),o=()=>{t.createNewTaskWindow(a,(e=>{e.createFields().click(),s.setDirty()}))},r=function(){const t=e(this),a=t.text();t.text(n("Saving...","aotfw-domain")),t.prop("disabled",!0),s.save().then((e=>{b.displayMessage(e.data.message)})).catch((e=>{b.displayMessage(e.data.message,!1)})).finally((()=>{setTimeout((()=>{t.text(a),t.prop("disabled",!1)}),1e3)}))},l=function(){const t=e(this).attr("href"),a=n('No log found. New entries can be written using the "Log To File" task',"aotfw-domain");return t.length?(e.ajax({url:t,type:"HEAD",success:function(){window.open(t,"_blank")},error:function(){b.displayMessage(a,!1)}}),!1):(b.displayMessage(a,!1),!1)},d=function(){e(this).data("last-selected",e(this).find("option:selected"))},c=function(){const a=e(this);if(s.isDirty()&&!confirm(n("Unsaved data will be lost. Proceed?","aotfw-domain")))return void a.data("last-selected").prop("selected",!0);const d=t.createBaseComponents(i);d.newTaskBtn.on("click",o),d.saveChangesBtn.on("click",r),d.viewLogLink.on("click",l),s.load()};i.on("click",d),i.on("change",c),d(),c()}))})();